---
title: "Baseball Analysis"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
  word_document: default
  pdf_document: 
    toc: yes
    toc_depth: 2
---

```{r}
###############################################################################
# Project: Baseball
# Author(s): Thomas Burr
# Date created: 2015 05 26
###############################################################################


################################################################################
# load in libraries and source files
################################################################################


# libraries:
librariesToLoad <- c('dplyr', 'tidyr', 'ggplot2','scales','ggthemes','Lahman')

suppressWarnings(suppressMessages(expr={
    sapply(librariesToLoad, function(package) {
        if (require(package, character.only=TRUE)){     
            print(paste(package, "loaded correctly", sep=" "))
        } else {
            print(paste("Installing", package, sep=" "))
            install.packages(package)
            
            if (require(package, character.only=TRUE)){
                print(paste(package, "loaded correctly", sep=" "))
            } else {
                stop(paste("Could not install", package, sep=" "))
            }
        }
    })
}))

```
#Data Summary

From the Lahmann database, we pull player-year level batting statistics from "Batting." Notice it lacks several aggregate statistics such as batting average, plate appearances, total bases, slugging, OBP, OPS, etc.

```{r}
data(Batting)
bstats = tbl_df(Batting)
batting
```

Luckily the Lahman package will automatically calculate these all for us and append them to the data. It also takes care of some convenient changes such as '2B' to 'X2B' in the variable name. Oddly it is still missing singles, which will be necessary for league wide slugging percentages.

```{r}
#Bring in available "advanced" batting stats
bstats <- tbl_df(battingStats())

#Filter to NL/AL Only
bstats <- bstats %>% filter(lgID == "NL" | lgID =="AL", PA > 0) 

#Add singles as a category
bstats <- bstats %>% mutate(X1B = H - X2B - X3B - HR)

```

For each year, we would like to know who the league leaders were in batting average and slugging percentage. 

```{r}
ba_league_leaders <- bstats %>% filter(PA > 400 & yearID > 1910) %>% 
                                group_by(yearID) %>% 
                                slice(which.max(BA)) %>% 
                                ungroup() %>% 
                                select(ba_leader = playerID,yearID,ba_leader_ba = BA,ba_leader_slg = SlugPct )

slg_league_leaders <- bstats %>% filter(PA > 400) %>% 
                                 group_by(yearID) %>% 
                                 slice(which.max(SlugPct)) %>% 
                                 ungroup() %>% 
                                 select(slg_leader = playerID,yearID,slg_leader_slg = SlugPct,slg_leader_ba = BA)

league_leaders <- merge(ba_league_leaders,slg_league_leaders,by="yearID")



bstats <- left_join(bstats,league_leaders, by = "yearID")


```

Lets compute the average batting average, slugging, etc. for each season for the players who had at least 100 ABs

```{r}
yearly_bstats <- bstats %>% filter(PA > 400)
yearly_bstats <- yearly_bstats %>% group_by(yearID) %>% summarize(
                                              ba_std = sd(BA),
                                              slg_std = sd(SlugPct),
                                              ba_avg = mean(BA),
                                              slg_avg = mean(SlugPct))

bstats <- left_join(bstats,yearly_bstats,by= 'yearID')
yearly_bstats <- merge(yearly_bstats,league_leaders,by="yearID")

```
One problem, however, is that these stats can only be calculated at the player level. Thus if we were to, for example, average all batting averages in a year, a player with 50 PA would weight equally as one with 500. We can get around this by creating a year-level total of the underlying stats (Hits, walks, 2B, HR etc.) and recalculating the percentages at a year level.

```{r}
#yearly_bstats <- bstats %>% group_by(yearID) %>% summarize(PA = sum(PA),AB = sum(AB), H = sum(H),
#                                                               BB = sum(BB),HBP = sum(HBP), X1B = sum(X1B), 
#                                                               X2B = sum(X2B),X3B = sum(X3B), HR = sum(HR),
#                                                               SF = sum(SF),
#                                                               SF = max(SF,0,na.rm=TRUE))
#yearly_bstats <- yearly_bstats %>% mutate(BA = H/AB, 
#                                                  OBP = (H + BB + HBP)/(AB + BB + HBP + SF),
#                                                  SLG = (X1B + 2 * X2B + 3 * X3B + 4 * HR)/AB,
#                                                  OPS = OBP + SLG)




ggplot(yearly_bstats,aes(x = yearID,y = ba_avg)) + geom_line() + theme_wsj() + scale_y_continuous(breaks = c(.240,.250,.260,.270,.280,.290,.300,.310),
                                                                                                  labels = c('.240','.250','.260','.270',
                                                                                                             '.280','.290','.300','.310'))

tidy_batting_percentages <- gather(yearly_bstats,statistic,average,ba_avg,slg_avg)


ggplot(tidy_batting_percentages,aes(x = yearID,y = average,color = statistic)) + geom_line() + theme_wsj() 


```

Batting Average vs league leader?

```{r}


ggplot(yearly_bstats,aes(x = yearID,y = ba_avg)) + geom_line() +stat_smooth(method = "lm") + theme_wsj() +ylim(.200,.450) +geom_point(data = yearly_bstats,aes(x=yearID,y=ba_leader_ba)) + theme_fivethirtyeight()

yearly_bstats$ba_max_spread <- yearly_bstats$ba_leader_ba - yearly_bstats$ba_avg

ggplot(yearly_bstats,aes(x = yearID,y = ba_max_spread, label = ba_leader)) + geom_point() +stat_smooth() + theme_wsj() +ylim(0,.200)

```

```{r}
ggplot(yearly_bstats,aes(x = yearID,y = slg_avg)) + geom_line() +stat_smooth(method = "lm") + theme_wsj() +ylim(.300,.800) +geom_point(data = yearly_bstats,aes(x=yearID,y=slg_leader_slg))

yearly_bstats$max_slg_spread<- yearly_bstats$slg_leader_slg- yearly_bstats$slg_avg

ggplot(yearly_bstats,aes(x = yearID,y = max_slg_spread)) + geom_point() +stat_smooth(method = "lm") + theme_fivethirtyeight() +ylim(0,.500)
```

```{r}

yearly_bstats <- yearly_bstats %>% mutate(std_away_ba = (ba_leader_ba - ba_avg)/ba_std,
                                          std_away_slg = (slg_leader_slg - slg_avg)/slg_std)

bstats <- bstats %>% filter(PA > 400) %>% mutate(std_away_ba = (BA - ba_avg)/ba_std,
                                          std_away_slg = (SlugPct - slg_avg)/slg_std)

ggplot(yearly_bstats,aes(x=yearID,y=std_away_ba,label = ba_leader)) + geom_text()

View(bstats %>% filter(PA > 400))


```